<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
   
    <title>Santorini Online</title>
</head>
    
<body>
    <div id="header">
        <h1>Santorini Online</h1>
        <div id="btnCont"></div>
    </div>
    <div id="container"></div>
    <h2 id="txtOut"></h2>

    <template id="loginTemplate">
        <div id="loginForm">
            <hr>
            <h1>Log-in</h1>
            <hr>
            <p>Welcome to our Santorini implementation!</p>
            <label for="nameInp"><b>Username:</b></label>
            <br>
            <input type="text" placeholder="Enter Username" id="nameInp" required minlength="3" maxlength="10" size="20">
            <p id="nameInpHelp"></p>
            <br>
            <label for="passInp"><b>Password:</b></label><br>
            <input type="password" placeholder="Enter Password" id="passInp" required minlength="1" maxlength="20" size="20">
            <input type="checkbox" id="check">
            <br>
            <p id="passInpHelp"></p><br>
            <button id="loginBtn">Log-in</button>
            <p>Don't have an account? <button id="signupBtn">Sign-up</button></p>
        </div>
    </template>
    <template id="signupTemplate">
        <div id="signupForm">
            <hr>
            <h1>Sign-up</h1>
            <hr>
            <p>Welcome to our Santorini implementation!</p>
            <label for="nameInp"><b>Username (3 to 10 characters):</b></label>
            <br>
            <input type="text" placeholder="Enter Username" id="nameInp" required minlength="3" maxlength="10" size="20">
            <p id="nameInpHelp"></p>
            <br>
            <label for="emailInp"><b>Email:</b></label><br>
            <input type="email" placeholder="Enter Email" id="emailInp" required minlength="3" size="20">
            <p id="emailInpHelp"></p>
            <br>
            <label for="passInp"><b>Password (8 to 20 characters):</b></label><br>
            <input type="password" placeholder="Enter Password" id="passInp" required minlength="8" maxlength="20" size="20"> 
            <input type="checkbox" id="check">
            <br>
            <p id="passInpHelp"></p><br>
            <p>Already have an account?<button id="loginBtn">Log-in</button></p>
            <button id="signupBtn">Sign-up</button>
        </div>
    </template>
    <template id="userViewTemplate">
        <div id="userView">
            <hr>
            <h2 id="welcome"></h2>
            <hr>
            <div id="account">
                <h3>My Account</h3>
                <hr>
                <label for="userUpdate"><b>Change Account settings:</b></label>
                <br>
                <button id="userUpdate">Settings</button>
                <br>
                <label for="logOut"><b>Log out: </b></label><br>
                <button id="logOut">Log-out</button>
                <br>
            </div>
            <div id="games">
                <h3>My Games</h3>
                <hr>
                <label for="gameStart"><b>Start a game: </b></label><br>
                <button id="gameStart">Start Game</button>
                <br>
                <label for="gameJoin"><b>Browse public and private games: </b></label><br>
                <button id="gameJoin">Join Game</button>
                <br>
                <label for="gameOngoing"><b>Browse public and private games you are taking part in: </b></label><br>
                <button id="gameOngoing">Ongoing Games</button>
                <br>
            </div>
        </div>
    </template>

</body>
<script>
    let cont = document.getElementById("container");
    let btnCont = document.getElementById("btnCont");
    let txtOut = document.getElementById("txtOut");
    document.body.onload = (evt) => {

        // Init
        console.log("We are running");
        let loginView = createLoginView();
        //document.body.appendChild(loginView);
        cont.appendChild(loginView);
    }

    
    //loadLogin();
    function loadLogin(){
        /*
        clearDiv(cont);
        let loginView = createLoginView();
        cont.appendChild(loginView);
        loginView.showData();
        check.addEventListener("click", function(evt){
            showPass(passInp);
        });
        loginBtn.addEventListener("click", async function(evt){
            if(nameInp.checkValidity() && passInp.checkValidity()){
                writeHtml(nameInpHelp, "");
                writeHtml(passInpHelp, "");
                let updata = {
                    name : nameInp.value,
                    pass : passInp.value
                }
                console.log("Data Sent to server");
                try{
                    let response = await model.postData(updata, `users/auth/${nameInp.value}`);
                    let data = await response.json();
                    if(response.status>202){
                        txtOut.innerHTML = data.msg;
                    }else{
                        txtOut.innerHTML = data.msg;
                        console.log("Welcome ", data.name);
                        //Save Session Info
                        sessionArray = [{"msg": data.msg,"id": data.id, "email": data.email, "name": data.name, "pass": data.pass}];
                        saveSessionArray("key", sessionArray);
                        
                        loadUserView(data);
                    }
                }catch(err){
                    console.log("Error in index", err);
                    txtOut.innerHTML = "Sorry, no valid data";
                }
            }else{
                writeHtml(nameInpHelp, "");
                writeHtml(passInpHelp, "");
                if(!nameInp.checkValidity()){
                    nameInpHelp.innerHTML = "Enter a valid name";
                }else{
                    passInpHelp.innerHTML = "Enter a valid password";
                }
            }        
        });
        signupBtn.addEventListener("click", function(evt){
            loadSignup();
        });
        clearDiv(btnCont);
        */
    }

    function loadSignup(){
        /*
        clearDiv(cont);
        let signupView = createSignupView();
        cont.appendChild(signupView);
        signupView.showData();
        check.addEventListener("click", function(evt){
            showPass(passInp);
        });
        loginBtn.addEventListener("click", function(evt){
            loadLogin();
        });
        signupBtn.addEventListener("click", async function(evt){
            
            if(nameInp.checkValidity() && passInp.checkValidity() && emailInp.checkValidity()){
                writeHtml(nameInpHelp, "");
                writeHtml(passInpHelp, "");
                writeHtml(emailInpHelp, "")
                let updata = {
                    name : nameInp.value,
                    email: emailInp.value,
                    pass : passInp.value
                }
                console.log("Data Sent to server");
                try{
                    let response = await model.postData(updata, `users/`);
                    let data = await response.json();
                    if(response.status>202){
                        txtOut.innerHTML = data.msg;
                    }else{
                        txtOut.innerHTML = data.msg;
                        console.log("Welcome ", data.name);
                        //Save Session Info
                        sessionArray = [{"msg": data.msg,"id": data.id, "email": data.email, "name": data.name, "pass": data.pass}];
                        saveSessionArray("key", sessionArray);
                        loadUserView(data);
                    }
                }catch(err){
                    console.log("Error in index", err);
                    txtOut.innerHTML = "Sorry, no valid data";
                }
            }else{
                writeHtml(nameInpHelp, "");
                writeHtml(passInpHelp, "");
                writeHtml(emailInpHelp, "")
                if(!nameInp.checkValidity()){
                    writeHtml(nameInpHelp, "Enter a valid username");
                }else if(!passInp.checkValidity()){
                    writeHtml(passInpHelp, "Enter a valid password");
                }else{
                    writeHtml(emailInpHelp, "Enter a valid email");
                }
            }        
        });
        clearDiv(btnCont);
        */
    }

    function loadUserView(copyData){
        //TO DO
        clearDiv(cont);
        let userView = createUserView();
        cont.appendChild(userView);
        userView.showData(copyData);
        userUpdate.addEventListener("click", function(evt){
            loadSettingsView(copyData);
        });
        logOut.addEventListener("click", async function(evt){
            txtOut.innerHTML = "";
            localStorage.clear();
            sessionStorage.clear();
            loadLogin();
        });
        gameStart.addEventListener("click", function(evt){

        });
        gameJoin.addEventListener("click", async function(evt){

        });
        gameOngoing.addEventListener("click", async function(evt){

        });
        chat.addEventListener("click", function(evt){
            loadChatView();
        });
        clearDiv(btnCont);
    }

    async function loadSettingsView(){
        clearDiv(cont);
        let settingsView = createSettingsView();
        cont.appendChild(settingsView);
        let copyData = loadSessionArray("key")[0];
        try{
            let response = await model.getData(`users/${copyData.id}`);
            let data = await response.json();
            if(response.status>202){
                txtOut.innerHTML = data.msg;
            }else{
                txtOut.innerHTML = data.msg;
                copyData = data;
            }
        }catch(err){
            console.log("Error in index", err);
            txtOut.innerHTML = "Sorry, no valid data";
        }
        settingsView.showData(copyData);
        nameInpBtn.addEventListener("click", async function(evt){
            txtOut.innerHTML = "";
            if(nameInp.checkValidity()){
                let updata = {
                    id : copyData.id,
                    email: copyData.email,
                    name : nameInp.value,
                    pass : copyData.pass
                }
                console.log(updata);
                try{
                    let response = await model.putData(updata, `users/${copyData.id}`);
                    let data = await response.json();
                    if(response.status>202){
                        txtOut.innerHTML = data.msg + "username.";
                    }else{
                        txtOut.innerHTML = data.msg;
                        //Save Session Info
                        sessionArray = [{"msg": data.msg,"id": data.id, "email": data.email, "name": data.name, "pass": data.pass}];
                        saveSessionArray("key", sessionArray);
                        loadSettingsView();
                    }
                }catch(err){
                    console.log("Error in index", err);
                    txtOut.innerHTML = "Sorry, no valid data";
                }
            }
        });
        emailInpBtn.addEventListener("click", async function(evt){
            txtOut.innerHTML = "";
            if(emailInp.checkValidity()){
                let updata = {
                    id : copyData.id,
                    email: emailInp.value,
                    name : copyData.name,
                    pass : copyData.pass
                }
                try{
                    let response = await model.putData(updata, `users/${copyData.id}`);
                    let data = await response.json();
                    if(response.status>202){
                        txtOut.innerHTML = data.msg + "email.";
                    }else{
                        txtOut.innerHTML = data.msg;
                        //Save Session Info
                        sessionArray = [{"msg": data.msg,"id": data.id, "email": data.email, "name": data.name, "pass": data.pass}];
                        saveSessionArray("key", sessionArray);
                        loadSettingsView();
                        
                    }
                }catch(err){
                    console.log("Error in index", err);
                    txtOut.innerHTML = "Sorry, no valid data";
                }
            }
        });
        passInpBtn.addEventListener("click", async function(evt){
            txtOut.innerHTML = "";
            if(passInpOld.checkValidity() && passInpNew.checkValidity()){
                //if(sessionStorage.getItem("key").pass == passInpOld.value){
                    let updata = {
                        id : copyData.id,
                        email: copyData.email,
                        name : copyData.name,
                        pass : passInpNew.value
                    }
                    try{
                        let response = await model.putData(updata, `users/${copyData.id}`);
                        let data = await response.json();
                        if(response.status>202){
                            txtOut.innerHTML = data.msg;
                        }else{
                            txtOut.innerHTML = data.msg;
                            //Save Session Info
                            sessionArray = [{"msg": data.msg,"id": data.id, "email": data.email, "name": data.name, "pass": data.pass}];
                            saveSessionArray("key", sessionArray);
                            loadSettingsView();
                        }
                    }catch(err){
                        console.log("Error in index", err);
                        txtOut.innerHTML = "Sorry, no valid data";
                    }
                //}
                
            }
        });
        userDel.addEventListener("click", async function(evt){
            if(window.confirm("Do you really want to delete your account?")){
                let updata = {
                    id : copyData.id
                }
                try{
                    let response = await model.deleteData(updata, `users/${copyData.id}`);
                    let data = await response.json();
                    if(response.status>202){
                        txtOut.innerHTML = data.msg;
                    }else{
                        txtOut.innerHTML = data.msg;
                        sessionStorage.clear();
                        loadLogin();
                    }
                }catch(err){
                    console.log("Error in index", err);
                    txtOut.innerHTML = "Sorry, no valid data";
                }
            }
        });
        clearDiv(btnCont);
        let backBtn = createElement(`<button id="backBtn">Back</button>`);
        btnCont.appendChild(backBtn);
        backBtn.addEventListener("click", function(evt){
            loadUserView(copyData);
        });
    }
    async function loadChatView(){
        clearDiv(cont);
        let chatView = createChatView();
        cont.appendChild(chatView);
        let copyData = loadSessionArray("key")[0];
        chatView.showData(copyData);

        send.addEventListener("click", function(evt){
            if(inpText.value!=null){
                chat.innerHTML +=`<p>${copyData.name}: "${inpText.value}"</p>`;
            }
        });
        clearDiv(btnCont);
        let backBtn = createElement(`<button id="backBtn">Back</button>`);
        btnCont.appendChild(backBtn);
        backBtn.addEventListener("click", function(evt){
            loadUserView(copyData);
        });
    }


</script>
<script src="util.js"></script>
<script src="view.js"></script>
<script src="service.js"></script>

</html>